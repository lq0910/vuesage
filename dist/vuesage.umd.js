!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("express")):"function"==typeof define&&define.amd?define(["exports","express"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).VueSage={},e.express)}(this,(function(e,t){"use strict";function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=s(t);function r(e){try{const t=/<template>[\s\S]*<\/template>/.test(e),s=/<script>[\s\S]*<\/script>/.test(e);return t&&s}catch(e){return!1}}function i(e){const t=e.match(/<template>([\s\S]*)<\/template>/);return t?t[1].trim():""}function o(e){const t=e.match(/<script>([\s\S]*)<\/script>/);return t?t[1].trim():""}function c(e){const t=[],s=/<style\b[^>]*>([\s\S]*?)<\/style>/g;let n;for(;null!==(n=s.exec(e));){const[e,s]=n,r=e.includes("scoped");t.push({content:s.trim(),scoped:r})}return t}function a(e,t,s){return`${e?`<template>\n${e}\n</template>\n\n`:""}${t?`<script>\n${t}\n<\/script>\n\n`:""}${s.map((e=>`<style${e.scoped?" scoped":""}>\n${e.content}\n</style>`)).join("\n\n")}`.trim()}var p=Object.freeze({__proto__:null,isValidVueComponent:r,extractTemplate:i,extractScript:o,extractStyles:c,mergeVueComponent:a});class l{constructor(e={}){this.options={maxLineLength:e.maxLineLength||80,requireComponentName:!1!==e.requireComponentName,requirePropsType:!1!==e.requirePropsType,requirePropsDefault:!1!==e.requirePropsDefault,requireVForKey:!1!==e.requireVForKey,requireScopedStyle:!1!==e.requireScopedStyle,maxMethodLines:e.maxMethodLines||20,maxMethods:e.maxMethods||10,maxNestingDepth:e.maxNestingDepth||3,...e}}analyze(e){if(!r(e))return{success:!1,summary:"无效的 Vue 组件代码",issues:[{type:"error",message:"代码必须包含 <template> 和 <script> 标签"}]};const t=i(e),s=o(e),n=c(e),a=[...this.analyzeTemplate(t),...this.analyzeScript(s),...this.analyzeStyles(n),...this.analyzeLifecycle(s),...this.analyzeComplexity(s),...this.analyzePerformance(t,s)];return{success:0===a.length,summary:a.length?`发现 ${a.length} 个问题`:"组件代码符合规范",issues:a}}analyzeTemplate(e){const t=[];if(this.options.requireVForKey){const s=/v-for\s*=\s*["'][^"']+["']/g,n=/:key\s*=\s*["'][^"']+["']/g,r=e.match(s)||[],i=e.match(n)||[];r.length>i.length&&t.push({type:"warning",message:"使用 v-for 指令时必须绑定 key 属性",fix:"addVForKey"})}return e.split("\n").forEach(((e,s)=>{e.length>this.options.maxLineLength&&t.push({type:"style",message:`第 ${s+1} 行超过 ${this.options.maxLineLength} 个字符`,fix:"formatLongLine",line:s+1})})),t}analyzeScript(e){const t=[];if(this.options.requireComponentName&&(e.includes("name:")||e.includes("name :")||t.push({type:"warning",message:"组件缺少 name 属性",fix:"addComponentName"})),this.options.requirePropsType){const s=e.match(/props\s*:\s*{([^}]+)}/);if(s){s[1].split(",").map((e=>e.trim())).forEach((e=>{e&&!e.includes("type:")&&t.push({type:"warning",message:"props 属性缺少类型定义",fix:"addPropsType",prop:e.split(":")[0].trim()})}))}}if(this.options.requirePropsDefault){const s=e.match(/props\s*:\s*{([^}]+)}/);if(s){s[1].split(",").map((e=>e.trim())).forEach((e=>{e&&!e.includes("default:")&&t.push({type:"warning",message:"props 属性缺少默认值",fix:"addPropsDefault",prop:e.split(":")[0].trim()})}))}}return t}analyzeStyles(e){const t=[];if(this.options.requireScopedStyle&&e.length>0){e.some((e=>e.scoped))||t.push({type:"warning",message:"建议使用 scoped 样式以避免样式污染",fix:"addScopedStyle"})}return t}analyzeLifecycle(e){const t=[],s={beforeDestroy:"beforeUnmount",destroyed:"unmounted"};Object.keys(s).forEach((n=>{(e.includes(n+":")||e.includes(n+" :"))&&t.push({type:"warning",message:`建议使用 ${s[n]} 替代废弃的 ${n} 生命周期方法`,fix:"updateLifecycle",oldHook:n,newHook:s[n]})}));return/async\s+mounted\s*\(\)/.test(e)&&t.push({type:"warning",message:"不建议在 mounted 中直接使用 async/await，可能导致组件渲染延迟",fix:"refactorAsyncMount"}),t}analyzeComplexity(e){const t=[],s=/\w+\s*\([^)]*\)\s*{([^}]*)}/g;let n;for(;null!==(n=s.exec(e));){const e=n[1].split("\n").length;e>this.options.maxMethodLines&&t.push({type:"warning",message:`方法过长（${e}行），建议不超过${this.options.maxMethodLines}行`,fix:"splitMethod"})}const r=(e.match(/\w+\s*\([^)]*\)\s*{/g)||[]).length;r>this.options.maxMethods&&t.push({type:"warning",message:`组件方法过多（${r}个），建议不超过${this.options.maxMethods}个`,fix:"extractMixin"});const i=this.getTemplateMaxDepth(e);return i>this.options.maxNestingDepth&&t.push({type:"warning",message:`模板嵌套深度过高（${i}层），建议不超过${this.options.maxNestingDepth}层`,fix:"extractComponent"}),t}analyzePerformance(e,t){const s=[],n=(e.match(/v-if/g)||[]).length,r=(e.match(/v-show/g)||[]).length;n>3&&r>3&&s.push({type:"performance",message:"过多混用 v-if 和 v-show 可能影响性能，建议统一使用一种方式",fix:"optimizeToggle"});const i=t.match(/computed:\s*{([^}]+)}/);if(i){const e=i[1];(e.includes("filter(")||e.includes("map(")||e.includes("reduce("))&&s.push({type:"performance",message:"计算属性中包含复杂数组操作，建议使用缓存或提前处理",fix:"optimizeComputed"})}const o=(t.match(/watch:/g)||[]).length;return o>5&&s.push({type:"performance",message:`组件包含大量的 watch（${o}个），可能影响性能`,fix:"optimizeWatch"}),s}getTemplateMaxDepth(e){let t=0,s=0;for(const n of e)"<"===n&&"/"!==e[e.indexOf(n)+1]?(s++,t=Math.max(t,s)):"<"===n&&"/"===e[e.indexOf(n)+1]&&s--;return t}}class u{constructor(e={}){this.config={formatOptions:{indent:e.indent||2,maxLineLength:e.maxLineLength||80},...e}}fix(e,t){if(!r(e))return{success:!1,error:"无效的Vue组件代码"};let s=i(e),n=o(e),p=c(e);const l=[];t.filter((e=>"template"===e.type)).forEach((e=>{const t=this.fixTemplate(s,e);t.success&&(s=t.code,l.push(t))})),t.filter((e=>"script"===e.type||"props"===e.type)).forEach((e=>{const t=this.fixScript(n,e);t.success&&(n=t.code,l.push(t))})),t.filter((e=>"style"===e.type)).forEach((e=>{const t=this.fixStyles(p,e);t.success&&(p=t.styles,l.push(t))}));return{success:!0,code:a(s,n,p),repairs:l}}fixTemplate(e,t){switch(t.message){case"v-for指令必须绑定key":return this.addVForKey(e);case/第\d+行超过\d+个字符/.test(t.message)&&t.message:return this.formatLongLine(e,t);default:return{success:!1,error:"不支持的修复类型"}}}fixScript(e,t){switch(t.message){case"组件缺少name属性":return this.addComponentName(e);case"props必须定义类型":return this.addPropsType(e);case"props建议设置默认值":return this.addPropsDefault(e);default:return{success:!1,error:"不支持的修复类型"}}}fixStyles(e,t){return e&&0!==e.length?{success:!1,error:"不支持的样式修复类型"}:{success:!0,styles:[{content:"",scoped:!0}],message:"添加了scoped样式块"}}addVForKey(e){const t=/<([^>]+)v-for=["']([^"']+)["']([^>]*)>/g;let s,n=e,r=!1;for(;null!==(s=t.exec(e));){const[e,t,i,o]=s;if(!o.includes(":key")&&!o.includes("v-bind:key")){const s=i.split(" in ")[0].trim(),c=`<${t}v-for="${i}" :key="${s}"${o}>`;n=n.replace(e,c),r=!0}}return{success:r,code:n,message:r?"添加了v-for的key绑定":"无需修复v-for的key绑定"}}addComponentName(e){const t=/export\s+default\s*{/;if(!e.includes("name:")){const s=this.generateComponentName();return{success:!0,code:e.replace(t,`export default {\n  name: '${s}',`),message:`添加了组件名称: ${s}`}}return{success:!1,message:"组件已有name属性"}}addPropsType(e){const t=/props:\s*{([^}]+)}/,s=e.match(t);if(s){const n=s[1].split(",").map((e=>e.trim())).map((e=>{if(e&&!e.includes("type:")){return`${e.split(":")[0].trim()}: { type: String }`}return e}));return{success:!0,code:e.replace(t,`props: {\n    ${n.join(",\n    ")}\n  }`),message:"为props添加了类型定义"}}return{success:!1,message:"未找到props定义"}}addPropsDefault(e){const t=/props:\s*{([^}]+)}/,s=e.match(t);if(s){const n=s[1].split(",").map((e=>e.trim())).map((e=>{if(e&&!e.includes("default:")){const[t,s]=e.split(":").map((e=>e.trim()));if(s.includes("type:")){const e=s.match(/type:\s*([^,}]+)/);if(e){const n=e[1].trim();return`${t}: { ${s}, default: ${this.getDefaultValueForType(n)} }`}}}return e}));return{success:!0,code:e.replace(t,`props: {\n    ${n.join(",\n    ")}\n  }`),message:"为props添加了默认值"}}return{success:!1,message:"未找到props定义"}}formatLongLine(e,t){const s=e.split("\n"),n=parseInt(t.message.match(/第(\d+)行/)[1])-1,r=s[n];if(r.length>80){const e=r.replace(/(\s+\w+="[^"]*")/g,"\n  $1");return s[n]=e,{success:!0,code:s.join("\n"),message:"格式化了过长的行"}}return{success:!1,message:"行长度正常，无需格式化"}}generateComponentName(){const e=Math.random().toString(36).substring(2,8);return"Vue"+e.charAt(0).toUpperCase()+e.slice(1)}getDefaultValueForType(e){switch(e.trim()){case"String":return"''";case"Number":return"0";case"Boolean":return"false";case"Array":return"[]";case"Object":return"{}";default:return"null"}}updateLifecycle(e,t){const{oldHook:s,newHook:n}=t,r=new RegExp(`${s}\\s*:\\s*`,"g");return{success:!0,code:e.replace(r,`${n}: `),message:`将 ${s} 更新为 ${n}`}}refactorAsyncMount(e){const t=/(async\s+)?mounted\s*\(\)\s*{([^}]*)}/,s=e.match(t);if(s){const n=s[2].replace(/await\s+([^;]+)/g,"this.$nextTick(async () => { await $1 })");return{success:!0,code:e.replace(t,`mounted() {${n}}`),message:"重构了 mounted 中的异步操作"}}return{success:!1,message:"未找到需要重构的 mounted 方法"}}optimizeComputed(e){const t=/computed:\s*{([^}]+)}/,s=e.match(t);if(s){const n=s[1],r=n.replace(/(\w+)\s*\(\)\s*{([^}]+)}/g,((e,t,s)=>{const r=s.includes("filter(")||s.includes("map(")||s.includes("reduce("),i=this.checkComputedDependencies(s,n),o=(s.match(/if|else|switch|case/g)||[]).length>2;if(r||i||o){return`${t}: {\n      cache: true,\n      get() {${this.optimizeComputedBody(s)}},\n      // 添加依赖追踪\n      dependencies: [${this.extractDependencies(s)}]\n    }`}return e}));return{success:!0,code:e.replace(t,`computed: {${r}}`),message:"优化了计算属性的性能"}}return{success:!1,message:"未找到需要优化的计算属性"}}optimizeComputedBody(e){const t=e.match(/(\w+)\.(filter|map|reduce).*?(?=;|\}|$)/g);if(t){return t.map((e=>e.includes(".filter(")&&e.includes(".map(")?this.combineArrayOperations(e):e.includes(".filter(")?`const arr = ${e.split(".")[0]};\n      if (!arr || arr.length === 0) return [];\n      ${e}`:e)).join("\n")}return e}combineArrayOperations(e){const t=e.split("."),s=t[0],n=t.slice(1),r=n.find((e=>e.includes("filter(")))?.match(/filter\((.*?)\)/)[1],i=n.find((e=>e.includes("map(")))?.match(/map\((.*?)\)/)[1];return`${s}.reduce((acc, item) => {\n      if (${r}) {\n        acc.push(${i});\n      }\n      return acc;\n    }, [])`}checkComputedDependencies(e,t){return(t.match(/\w+\s*\(\)/g)||[]).some((t=>e.includes(t.replace("()",""))))}extractDependencies(e){const t=new Set;(e.match(/this\.(\w+)/g)||[]).forEach((e=>{t.add(`'${e.replace("this.","")}'`)}));return(e.match(/props\.(\w+)/g)||[]).forEach((e=>{t.add(`'${e.replace("props.","")}'`)})),Array.from(t).join(", ")}optimizeToggle(e){const t=new Map,s=/v-if="([^"]+)"/g;let n;for(;null!==(n=s.exec(e));){const e=n[1];t.set(e,{complexity:this.analyzeConditionComplexity(e),frequency:this.estimateToggleFrequency(e)})}let r=e;return t.forEach(((e,t)=>{e.complexity<3&&e.frequency>.7&&(r=r.replace(new RegExp(`v-if="${t}"`,"g"),`v-show="${t}"`))})),{success:!0,code:r,message:"智能优化了条件渲染指令的使用"}}analyzeConditionComplexity(e){let t=0;return t+=(e.match(/&&|\|\|/g)||[]).length,t+=(e.match(/\w+\(/g)||[]).length,t+=2*(e.match(/\?/g)||[]).length,t}estimateToggleFrequency(e){return e.includes("loading")?.9:e.includes("visible")||e.includes("show")?.8:e.includes("active")||e.includes("selected")?.7:e.includes("error")||e.includes("valid")?.5:.3}splitMethod(e,t){const s=e.match(/(\w+)\s*\([^)]*\)\s*{([^}]*)}/);if(s){const[t,n,r]=s;if(r.split("\n").length>this.config.formatOptions.maxLineLength){const s=this.analyzeMethodBlocks(r),{mainMethod:i,helperMethods:o}=this.splitMethodByBlocks(n,s);return{success:!0,code:e.replace(t,`${i}\n${o.join("\n")}`),message:`将 ${n} 方法智能拆分为多个方法`}}}return{success:!1,message:"未找到需要拆分的方法"}}analyzeMethodBlocks(e){const t=[];let s={lines:[],type:"unknown",complexity:0};return e.split("\n").forEach((e=>{e.includes("if")||e.includes("switch")?(s.lines.length>0&&t.push(s),s={lines:[e],type:"condition",complexity:1}):e.includes("for")||e.includes("while")?(s.lines.length>0&&t.push(s),s={lines:[e],type:"loop",complexity:2}):e.includes("try")||e.includes("catch")?(s.lines.length>0&&t.push(s),s={lines:[e],type:"error_handling",complexity:1}):(s.lines.push(e),(e.includes("&&")||e.includes("||"))&&s.complexity++)})),s.lines.length>0&&t.push(s),t}splitMethodByBlocks(e,t){const s=[];let n=[];t.forEach(((t,r)=>{if(t.complexity>1||t.lines.length>5){const i=`${e}${this.getHelperSuffix(t.type)}${r+1}`,o=`\n  ${i}() {\n    ${t.lines.join("\n    ")}\n  }`;s.push(o),n.push(`    this.${i}();`)}else n.push(...t.lines)}));return{mainMethod:`\n  ${e}() {\n    ${n.join("\n    ")}\n  }`,helperMethods:s}}getHelperSuffix(e){switch(e){case"condition":return"Condition";case"loop":return"Process";case"error_handling":return"ErrorHandler";default:return"Helper"}}extractComponent(e,t){const s=this.generateComponentName(),n=e.match(/<template>([\s\S]*)<\/template>/);if(n){const t=n[1],r=this.findDeepestNesting(t);if(r){const t=`\n<template>\n  ${r}\n</template>\n\n<script>\nexport default {\n  name: '${s}'\n}\n<\/script>`;return{success:!0,code:e.replace(r,`<${s} />`),newComponent:t,message:`提取了嵌套组件到新文件 ${s}.vue`}}}return{success:!1,message:"未找到需要提取的嵌套组件"}}findDeepestNesting(e){const t=e.match(/<[^>]+>([^<]*(?:(?!<\/).)*?)<\/[^>]+>/g)||[];let s="",n=0;return t.forEach((e=>{const t=(e.match(/</g)||[]).length;t>n&&(n=t,s=e)})),s}}require("fs"),require("path"),require("lodash");const m={port:6188,host:"localhost"},h=n.default(),d=new class{constructor(){this.analyzer=new l,this.fixer=new u}async analyze(e){return await this.analyzer.analyze(e)}async fix(e,t){return await this.fixer.fix(e,t)}transformIssues(e){const t={};return e.forEach((e=>{t[e.type]||(t[e.type]={category:this.getCategoryName(e.type),issues:[]}),t[e.type].issues.push({type:e.type,severity:e.severity,message:e.message,autofix:e.fix?{type:e.fix,description:this.getFixDescription(e.fix)}:null})})),Object.values(t)}getCategoryName(e){return{template:"模板相关",script:"脚本相关",style:"样式相关",general:"通用问题"}[e]||e}getFixType(e){return e.includes("v-for")?"template-vfor-key":e.includes("样式")?"style-scoped":e.includes("行长度")?"format-long-line":"general"}getFixDescription(e){return{"add-v-for-key":"添加v-for的:key绑定","add-scoped-style":"添加scoped样式","format-long-line":"格式化过长的代码行","add-style-section":"添加样式部分"}[e]||e}};h.use(n.default.json()),h.use(n.default.static("public")),h.post("/analyze",(async(e,t)=>{try{const{component:s}=e.body,n=await d.analyze(s);t.json(n)}catch(e){t.status(500).json({error:e.message})}})),h.post("/fix",(async(e,t)=>{try{const{component:s,issues:n}=e.body,r=await d.fix(s,n);t.json(r)}catch(e){t.status(500).json({error:e.message})}})),h.listen(m.port,m.host,(()=>{console.log(`VueSage 服务已启动: http://${m.host}:${m.port}`)}));var f={analyze:e=>(new l).analyze(e),fix:(e,t)=>(new u).fix(e,t)};e.VueAnalyzer=l,e.VueFixer=u,e.default=f,e.utils=p,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=vuesage.umd.js.map
